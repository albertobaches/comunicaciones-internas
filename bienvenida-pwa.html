<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comunicaciones - Iniciando...</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest-bienvenida.json">
    <meta name="theme-color" content="#2196F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Comunicaciones">
    
    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="img/app-icon.svg">
    <link rel="apple-touch-icon" href="img/app-icon-192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: white;
            overflow-x: hidden;
        }
        
        .container {
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        
        .logo {
            width: 100px;
            height: 100px;
            margin: 0 auto 30px;
            background: white;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        }
        
        .logo svg {
            width: 60px;
            height: 60px;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        h1 {
            font-size: 2.2em;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        .status {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .status-text {
            font-size: 1.1em;
            margin-bottom: 15px;
            font-weight: 500;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #4CAF50;
            border-radius: 3px;
            transition: width 0.5s ease;
            width: 0%;
        }
        
        .step {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .step.completed {
            background: rgba(76, 175, 80, 0.3);
        }
        
        .step.current {
            background: rgba(33, 150, 243, 0.3);
            animation: glow 1.5s infinite alternate;
        }
        
        .step.error {
            background: rgba(244, 67, 54, 0.3);
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 5px rgba(33, 150, 243, 0.5); }
            to { box-shadow: 0 0 15px rgba(33, 150, 243, 0.8); }
        }
        
        .step-icon {
            font-size: 1.2em;
            margin-right: 10px;
        }
        
        .manual-btn {
            background: #FF9800;
            color: white;
            border: none;
            padding: 15px 25px;
            font-size: 1em;
            border-radius: 25px;
            cursor: pointer;
            margin: 15px 5px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .manual-btn:hover {
            background: #F57C00;
            transform: translateY(-2px);
        }
        
        .retry-btn {
            background: #2196F3;
        }
        
        .retry-btn:hover {
            background: #1976D2;
        }
        
        .hidden {
            display: none !important;
        }
        
        .error-details {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #F44336;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9em;
        }
        
        .success-message {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="#2196F3"/>
                <path d="M30 40 L50 25 L70 40 L70 75 L30 75 Z" fill="white"/>
                <circle cx="50" cy="55" r="8" fill="#2196F3"/>
            </svg>
        </div>
        
        <h1>Comunicaciones</h1>
        
        <div class="status">
            <div class="status-text" id="status-text">üöÄ Iniciando aplicaci√≥n...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            
            <div id="steps-container">
                <div class="step current" id="step-1">
                    <span><span class="step-icon">üîç</span>Verificando conexi√≥n</span>
                    <span id="step-1-status">‚è≥</span>
                </div>
                <div class="step" id="step-2">
                    <span><span class="step-icon">üîí</span>Validando certificado</span>
                    <span id="step-2-status">‚è≥</span>
                </div>
                <div class="step" id="step-3">
                    <span><span class="step-icon">üì±</span>Cargando aplicaci√≥n</span>
                    <span id="step-3-status">‚è≥</span>
                </div>
            </div>
        </div>
        
        <div id="error-section" class="hidden">
            <div class="error-details">
                <strong>‚ùå Error detectado:</strong>
                <div id="error-message"></div>
            </div>
            
            <button class="manual-btn retry-btn" onclick="retryConnection()">
                üîÑ Reintentar
            </button>
            
            <a href="http://192.168.1.123:8001/inicio-simple.html?source=fallback" class="manual-btn">
                üåê Usar HTTP
            </a>
        </div>
        
        <div id="success-section" class="hidden">
            <div class="success-message">
                <strong>‚úÖ ¬°Aplicaci√≥n lista!</strong>
                <div>Redirigiendo autom√°ticamente...</div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let progress = 0;
        let retryCount = 0;
        const maxRetries = 3;
        
        function updateProgress(percent) {
            progress = percent;
            document.getElementById('progress-fill').style.width = percent + '%';
        }
        
        function updateStep(stepNum, status, icon) {
            const step = document.getElementById(`step-${stepNum}`);
            const statusEl = document.getElementById(`step-${stepNum}-status`);
            
            step.classList.remove('current', 'completed', 'error');
            
            if (status === 'completed') {
                step.classList.add('completed');
                statusEl.textContent = '‚úÖ';
            } else if (status === 'error') {
                step.classList.add('error');
                statusEl.textContent = '‚ùå';
            } else if (status === 'current') {
                step.classList.add('current');
                statusEl.textContent = '‚è≥';
            }
        }
        
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-section').classList.remove('hidden');
            document.getElementById('status-text').textContent = '‚ùå Error en la conexi√≥n';
        }
        
        function showSuccess() {
            document.getElementById('success-section').classList.remove('hidden');
            document.getElementById('status-text').textContent = '‚úÖ ¬°Aplicaci√≥n lista!';
            updateProgress(100);
        }
        
        async function testConnection() {
            console.log('üîç Paso 1: Verificando conexi√≥n...');
            updateStep(1, 'current');
            updateProgress(10);
            
            try {
                // Intentar conexi√≥n HTTPS primero
                const response = await fetch('https://192.168.1.123:8443/inicio-simple.html', {
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                
                console.log('‚úÖ Conexi√≥n HTTPS exitosa');
                updateStep(1, 'completed');
                updateProgress(33);
                return await testCertificate();
                
            } catch (error) {
                console.log('‚ùå Error en conexi√≥n HTTPS:', error);
                updateStep(1, 'error');
                
                // Intentar HTTP como fallback
                try {
                    await fetch('http://192.168.1.123:8001/inicio-simple.html', {
                        method: 'HEAD',
                        mode: 'no-cors'
                    });
                    
                    console.log('‚úÖ Conexi√≥n HTTP disponible como fallback');
                    showError('HTTPS no disponible. Usa el bot√≥n "Usar HTTP" para continuar.');
                    return false;
                    
                } catch (httpError) {
                    console.log('‚ùå Error en ambas conexiones:', httpError);
                    showError('No se puede conectar al servidor. Verifica tu conexi√≥n de red.');
                    return false;
                }
            }
        }
        
        async function testCertificate() {
            console.log('üîí Paso 2: Validando certificado...');
            updateStep(2, 'current');
            updateProgress(50);
            
            // Esperar un momento para que el usuario vea el progreso
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            try {
                // M√∫ltiples intentos de verificaci√≥n de certificado
                const testUrls = [
                    'https://192.168.1.123:8443/img/app-icon.svg',
                    'https://192.168.1.123:8443/manifest.json',
                    'https://192.168.1.123:8443/acceso-publico.html'
                ];
                
                let certificateValid = false;
                let lastError = null;
                
                for (const testUrl of testUrls) {
                    try {
                        console.log(`üîç Probando certificado con: ${testUrl}`);
                        const response = await fetch(testUrl, {
                            method: 'HEAD',
                            cache: 'no-cache',
                            credentials: 'omit'
                        });
                        
                        if (response.ok || response.status === 404) {
                            certificateValid = true;
                            console.log('‚úÖ Certificado v√°lido confirmado');
                            break;
                        }
                    } catch (error) {
                        lastError = error;
                        console.log(`‚ùå Error con ${testUrl}:`, error.message);
                    }
                }
                
                if (certificateValid) {
                    updateStep(2, 'completed');
                    updateProgress(66);
                    return await loadApplication();
                } else {
                    throw lastError || new Error('Certificado no aceptado');
                }
                
            } catch (error) {
                console.log('‚ùå Error de certificado:', error);
                updateStep(2, 'error');
                
                // Mensaje m√°s espec√≠fico seg√∫n el tipo de error
                let errorMessage = 'Certificado SSL no aceptado. ';
                
                if (error.message.includes('net::ERR_CERT_AUTHORITY_INVALID')) {
                    errorMessage += 'El certificado no es de confianza. Acepta el certificado en tu navegador.';
                } else if (error.message.includes('net::ERR_CERT_COMMON_NAME_INVALID')) {
                    errorMessage += 'El nombre del certificado no coincide.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage += 'No se puede conectar de forma segura. Verifica el certificado.';
                } else {
                    errorMessage += 'Acepta el certificado en tu navegador y reintenta.';
                }
                
                showError(errorMessage);
                return false;
            }
        }
        
        async function loadApplication() {
            console.log('üì± Paso 3: Cargando aplicaci√≥n...');
            updateStep(3, 'current');
            updateProgress(80);
            
            // Esperar un momento para mostrar el progreso
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            try {
                // Verificar que la aplicaci√≥n principal est√© disponible
                const appResponse = await fetch('https://192.168.1.123:8443/inicio-simple.html');
                
                if (appResponse.ok) {
                    console.log('‚úÖ Aplicaci√≥n cargada exitosamente');
                    updateStep(3, 'completed');
                    showSuccess();
                    
                    // Redirigir despu√©s de mostrar el √©xito
                    setTimeout(() => {
                        window.location.href = 'https://192.168.1.123:8443/inicio-simple.html?source=pwa-installed';
                    }, 2000);
                    
                    return true;
                } else {
                    throw new Error('Aplicaci√≥n no disponible');
                }
                
            } catch (error) {
                console.log('‚ùå Error cargando aplicaci√≥n:', error);
                updateStep(3, 'error');
                showError('Error cargando la aplicaci√≥n. Reintenta o usa la versi√≥n HTTP.');
                return false;
            }
        }
        
        async function retryConnection() {
            if (retryCount >= maxRetries) {
                showError('M√°ximo n√∫mero de reintentos alcanzado. Usa la versi√≥n HTTP.');
                return;
            }
            
            retryCount++;
            console.log(`üîÑ Reintento ${retryCount}/${maxRetries}`);
            
            // Resetear estado
            document.getElementById('error-section').classList.add('hidden');
            document.getElementById('success-section').classList.add('hidden');
            updateProgress(0);
            
            // Resetear pasos
            for (let i = 1; i <= 3; i++) {
                updateStep(i, '');
                document.getElementById(`step-${i}-status`).textContent = '‚è≥';
            }
            
            document.getElementById('status-text').textContent = 'üîÑ Reintentando conexi√≥n...';
            
            // Esperar un momento antes de reintentar
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testConnection();
        }
        
        // Detectar si estamos en modo PWA instalada
        function isPWAInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches ||
                   window.navigator.standalone === true ||
                   document.referrer.includes('android-app://');
        }
        
        // Iniciar el proceso cuando la p√°gina carga
        window.addEventListener('load', async () => {
            console.log('üöÄ Iniciando proceso de conexi√≥n PWA');
            console.log('üì± User Agent:', navigator.userAgent);
            console.log('üîß Standalone mode:', window.matchMedia('(display-mode: standalone)').matches);
            console.log('üçé iOS Standalone:', window.navigator.standalone);
            console.log('üì± Es PWA instalada:', isPWAInstalled());
            
            // Si no estamos en PWA instalada, redirigir a la p√°gina principal
            if (!isPWAInstalled()) {
                console.log('üåê No es PWA instalada, redirigiendo...');
                window.location.href = 'https://192.168.1.123:8443/inicio-simple.html?source=browser-direct';
                return;
            }
            
            // Configurar monitoreo de conectividad
            setupConnectivityMonitoring();
            
            // Verificar estado inicial de la red
            if (!checkNetworkStatus()) {
                return; // Si no hay conectividad, no continuar
            }
            
            // Esperar un momento para mostrar la interfaz
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testConnection();
        });
        
        // Manejar errores globales
        window.addEventListener('error', (event) => {
            console.error('‚ùå Error global:', event.error);
            showError('Error inesperado: ' + event.error.message);
        });
        
        // Detecci√≥n avanzada de conectividad
        function checkNetworkStatus() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            
            if (connection) {
                console.log('üì∂ Tipo de conexi√≥n:', connection.effectiveType);
                console.log('üìä Velocidad estimada:', connection.downlink + ' Mbps');
                console.log('üîÑ RTT:', connection.rtt + ' ms');
                
                // Advertir si la conexi√≥n es lenta
                if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
                    console.log('‚ö†Ô∏è Conexi√≥n lenta detectada');
                    document.getElementById('status-text').textContent = '‚ö†Ô∏è Conexi√≥n lenta detectada...';
                }
            }
            
            // Verificar estado online/offline
            if (!navigator.onLine) {
                showError('Sin conexi√≥n a internet. Verifica tu red.');
                return false;
            }
            
            return true;
        }
        
        // Monitorear cambios de conectividad
        function setupConnectivityMonitoring() {
            // Eventos b√°sicos de conectividad
            window.addEventListener('offline', () => {
                console.log('üìµ Conexi√≥n perdida');
                showError('Sin conexi√≥n a internet. Verifica tu red.');
            });
            
            window.addEventListener('online', () => {
                console.log('üåê Conexi√≥n restaurada');
                if (document.getElementById('error-section').classList.contains('hidden') === false) {
                    retryConnection();
                }
            });
            
            // Monitorear cambios en la calidad de conexi√≥n
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (connection) {
                connection.addEventListener('change', () => {
                    console.log('üì∂ Cambio en la conexi√≥n:', connection.effectiveType);
                    checkNetworkStatus();
                });
            }
            
            // Verificaci√≥n peri√≥dica de conectividad
            setInterval(async () => {
                if (navigator.onLine) {
                    try {
                        // Ping simple para verificar conectividad real
                        await fetch('https://192.168.1.123:8443/manifest.json', {
                            method: 'HEAD',
                            cache: 'no-cache',
                            signal: AbortSignal.timeout(5000)
                        });
                        console.log('‚úÖ Conectividad verificada');
                    } catch (error) {
                        console.log('‚ùå Problema de conectividad:', error.message);
                        if (!document.getElementById('error-section').classList.contains('hidden')) {
                            // Ya hay un error mostrado, no duplicar
                            return;
                        }
                        showError('Problemas de conectividad detectados. Verificando...');
                    }
                }
            }, 30000); // Verificar cada 30 segundos
        }
    </script>
</body>
</html>