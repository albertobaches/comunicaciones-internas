<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comunicaciones Internas - Inicio Simple</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2196F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Comunicaciones">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="/img/app-icon.svg">
    <link rel="icon" type="image/svg+xml" href="/img/app-icon.svg">
    
    <!-- Manifest -->
    <link rel="manifest" href="/manifest-simple.json">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .welcome-container {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }
        
        .app-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
            background: white;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .subtitle {
            opacity: 0.9;
            margin-bottom: 2rem;
            font-size: 1rem;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .status {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.3);
        }
        
        .success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid rgba(0, 255, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="welcome-container">
        <div class="app-icon">üì±</div>
        <h1>Comunicaciones Internas</h1>
        <p class="subtitle">Versi√≥n Simplificada</p>
        
        <div id="status" class="status">
            <div class="loading"></div>
            Iniciando aplicaci√≥n...
        </div>
    </div>

    <script>
        console.log('üöÄ Inicio simple - Sin Service Worker');
        
        // Detectar par√°metros de URL y origen
        const urlParams = new URLSearchParams(window.location.search);
        const source = urlParams.get('source');
        
        // Detectar modo PWA
        function isPWAMode() {
            return window.matchMedia('(display-mode: standalone)').matches ||
                   window.navigator.standalone === true ||
                   document.referrer.includes('android-app://');
        }
        
        const isPWA = isPWAMode();
        
        console.log('üì± Modo PWA:', isPWA);
        console.log('üìç Origen:', source || 'directo');
        console.log('üåê URL actual:', window.location.href);
        console.log('üîó Protocol:', window.location.protocol);
        
        // Mostrar informaci√≥n seg√∫n el origen
        function handleSourceInfo() {
            const statusMessages = {
                'pwa-installed': 'üéâ ¬°Aplicaci√≥n PWA cargada exitosamente!',
                'browser-direct': 'üåê Acceso desde navegador web',
                'fallback': '‚ö†Ô∏è Modo de compatibilidad HTTP activado',
                'manual': 'üë§ Acceso manual desde p√°gina principal'
            };
            
            if (source && statusMessages[source]) {
                console.log('üìç Origen detectado:', statusMessages[source]);
                
                // Mostrar mensaje temporal si viene de PWA instalada
                if (source === 'pwa-installed') {
                    const container = document.querySelector('.welcome-container');
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = `
                        background: rgba(76, 175, 80, 0.2);
                        border: 1px solid #4CAF50;
                        border-radius: 10px;
                        padding: 15px;
                        margin: 15px 0;
                        font-size: 0.9em;
                        animation: slideIn 0.5s ease;
                    `;
                    successMsg.innerHTML = '‚úÖ <strong>PWA instalada correctamente</strong><br>La aplicaci√≥n se ejecuta de forma nativa.';
                    container.insertBefore(successMsg, container.firstChild);
                    
                    // Auto-ocultar despu√©s de 5 segundos
                    setTimeout(() => {
                        successMsg.style.opacity = '0.7';
                    }, 5000);
                }
            }
        }
        
        // Registrar Service Worker si est√° disponible
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ùå Error registrando Service Worker:', error);
                    });
            });
        }
        
        // Mostrar informaci√≥n de instalaci√≥n
        window.addEventListener('load', () => {
            const isStandalone = isPWAMode();
            
            console.log('üì± Modo PWA:', isStandalone);
            console.log('üìç Origen:', source || 'directo');
            console.log('üîí Protocolo:', location.protocol);
            
            if (isStandalone) {
                console.log('üéâ Ejecut√°ndose como PWA instalada');
            } else {
                console.log('üåê Ejecut√°ndose en navegador');
            }
            
            // Manejar informaci√≥n de origen
            handleSourceInfo();
        });
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            if (statusEl) {
                statusEl.innerHTML = message;
                statusEl.className = 'status';
                if (type === 'error') statusEl.classList.add('error');
                if (type === 'success') statusEl.classList.add('success');
            }
        }
        
        function redirectToLogin() {
            try {
                updateStatus('‚úÖ Redirigiendo al login...', 'success');
                console.log('üîÑ Redirigiendo a login.html');
                
                // Usar URL relativa para evitar problemas de protocolo
                const loginUrl = './login.html';
                console.log('üéØ URL de destino:', loginUrl);
                
                setTimeout(() => {
                    window.location.href = loginUrl;
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Error en redirecci√≥n:', error);
                updateStatus('‚ùå Error en redirecci√≥n: ' + error.message, 'error');
                
                // Fallback: intentar con URL absoluta
                setTimeout(() => {
                    try {
                        const baseUrl = window.location.origin;
                        window.location.href = baseUrl + '/login.html';
                    } catch (fallbackError) {
                        console.error('‚ùå Error en fallback:', fallbackError);
                        updateStatus('‚ùå Recarga la p√°gina manualmente', 'error');
                    }
                }, 3000);
            }
        }
        
        // Funci√≥n para verificar conectividad
        function checkConnectivity() {
            return fetch('./login.html', { method: 'HEAD' })
                .then(response => {
                    console.log('‚úÖ Conectividad OK, status:', response.status);
                    return true;
                })
                .catch(error => {
                    console.error('‚ùå Error de conectividad:', error);
                    return false;
                });
        }
        
        // Inicializaci√≥n mejorada
        setTimeout(async () => {
            if (isPWA) {
                updateStatus('üì± Modo PWA detectado', 'success');
                console.log('‚úÖ Ejecut√°ndose como PWA instalada');
            } else {
                updateStatus('üåê Modo navegador detectado', 'success');
                console.log('‚úÖ Ejecut√°ndose en navegador');
            }
            
            // Verificar conectividad antes de redirigir
            updateStatus('üîç Verificando conectividad...', 'info');
            const isConnected = await checkConnectivity();
            
            if (isConnected) {
                updateStatus('‚úÖ Conectividad verificada', 'success');
                setTimeout(redirectToLogin, 1000);
            } else {
                updateStatus('‚ùå Sin conectividad. Reintentando...', 'error');
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }
            
        }, 1000);
        
        // Error handler global mejorado
        window.addEventListener('error', (event) => {
            console.error('‚ùå Error global:', event.error);
            updateStatus('‚ùå Error: ' + (event.error?.message || 'Error desconocido'), 'error');
        });
        
        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', (event) => {
            console.error('‚ùå Promise rejection:', event.reason);
            updateStatus('‚ùå Error de promesa: ' + event.reason, 'error');
            event.preventDefault(); // Prevenir que aparezca en consola
        });
        
        // Handler para cuando la p√°gina se vuelve visible (√∫til para PWAs)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                console.log('üëÅÔ∏è P√°gina visible de nuevo');
            }
        });
    </script>
</body>
</html>