name: ðŸš€ Deploy to Render

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permite ejecuciÃ³n manual

jobs:
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ” Lint with flake8
      run: |
        pip install flake8
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true
        
    - name: âœ… Test application files
      run: |
        echo "Testing application files and structure..."
        
        # Check if main files exist
        if [ ! -f "app.py" ]; then
          echo "âŒ app.py not found"
          exit 1
        fi
        
        if [ ! -f "wsgi.py" ]; then
          echo "âŒ wsgi.py not found"
          exit 1
        fi
        
        if [ ! -f "requirements.txt" ]; then
          echo "âŒ requirements.txt not found"
          exit 1
        fi
        
        # Check Python syntax
        echo "Checking Python syntax..."
        python -m py_compile app.py
        python -m py_compile wsgi.py
        
        # Simple import test without Flask dependencies
        python -c "
        import sys
        import os
        
        # Check if files can be read
        with open('app.py', 'r') as f:
            content = f.read()
            if 'Flask' in content and 'app = Flask' in content:
                print('âœ… app.py contains Flask application')
            else:
                print('âŒ app.py does not contain valid Flask app')
                sys.exit(1)
                
        with open('wsgi.py', 'r') as f:
            content = f.read()
            if 'application' in content and 'app' in content:
                print('âœ… wsgi.py contains application reference')
            else:
                print('âŒ wsgi.py does not contain valid application')
                sys.exit(1)
        
        print('âœ… All application files are valid')
        "

  validate-config:
    name: ðŸ”§ Validate Configuration
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ” Validate render.yaml
      run: |
        echo "Validating render.yaml configuration..."
        
        # Check if render.yaml exists
        if [ ! -f "render.yaml" ]; then
          echo "âŒ render.yaml not found"
          exit 1
        fi
        
        # Check for required fields
        if grep -q "gunicorn --bind 0.0.0.0:\$PORT wsgi:application" render.yaml; then
          echo "âœ… Correct start command found"
        else
          echo "âŒ Incorrect or missing start command"
          exit 1
        fi
        
        if grep -q "type: web" render.yaml; then
          echo "âœ… Web service type configured"
        else
          echo "âŒ Web service type not configured"
          exit 1
        fi
        
        if grep -q "DATABASE_URL" render.yaml; then
          echo "âœ… Database URL configuration found"
        else
          echo "âŒ Database URL configuration missing"
          exit 1
        fi
        
        echo "âœ… render.yaml validation passed"
        
    - name: ðŸ” Validate required files
      run: |
        echo "Checking required files..."
        
        REQUIRED_FILES=("wsgi.py" "server.py" "requirements.txt" "database_postgres.py")
        
        for file in "${REQUIRED_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… Found: $file"
          else
            echo "âŒ Missing: $file"
            exit 1
          fi
        done
        
        echo "âœ… All required files present"

  deploy-notification:
    name: ðŸ“¢ Deployment Ready
    runs-on: ubuntu-latest
    needs: [test, validate-config]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŽ‰ Deployment Ready Notification
      run: |
        echo "ðŸš€ DEPLOYMENT READY!"
        echo "==================="
        echo ""
        echo "âœ… All tests passed"
        echo "âœ… Configuration validated"
        echo "âœ… Code pushed to main branch"
        echo ""
        echo "ðŸŒ Next steps:"
        echo "1. Go to: https://dashboard.render.com"
        echo "2. Your service should auto-deploy from this commit"
        echo "3. If this is the first deployment:"
        echo "   - Click 'New +' â†’ 'Web Service'"
        echo "   - Select repository: ${{ github.repository }}"
        echo "   - Render will detect render.yaml automatically"
        echo "   - Click 'Create Web Service'"
        echo ""
        echo "ðŸ“Š Commit Info:"
        echo "- SHA: ${{ github.sha }}"
        echo "- Message: ${{ github.event.head_commit.message }}"
        echo "- Author: ${{ github.event.head_commit.author.name }}"
        echo ""
        echo "ðŸ”— Repository: https://github.com/${{ github.repository }}"
        
    - name: ðŸ“ Create deployment summary
      run: |
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        # ðŸš€ Deployment Status
        
        ## âœ… Ready for Render Deployment
        
        Your application has passed all checks and is ready to deploy!
        
        ### ðŸ“‹ Validation Results
        - âœ… **Tests**: All tests passed
        - âœ… **Configuration**: render.yaml validated
        - âœ… **Files**: All required files present
        - âœ… **Dependencies**: requirements.txt verified
        
        ### ðŸŒ Deploy to Render
        1. Visit [Render Dashboard](https://dashboard.render.com)
        2. Create new Web Service (if first time)
        3. Select repository: `${{ github.repository }}`
        4. Render will auto-detect configuration
        5. Click "Create Web Service"
        
        ### ðŸ“Š Commit Details
        - **SHA**: `${{ github.sha }}`
        - **Branch**: `${{ github.ref_name }}`
        - **Author**: ${{ github.event.head_commit.author.name }}
        
        ---
        *Automated deployment validation completed at ${{ github.event.head_commit.timestamp }}*
        EOF

  # Job opcional para notificaciones (requiere configuraciÃ³n de secrets)
  notify-slack:
    name: ðŸ“± Notify Team
    runs-on: ubuntu-latest
    needs: [deploy-notification]
    if: github.ref == 'refs/heads/main' && false  # Deshabilitado por defecto
    
    steps:
    - name: ðŸ“± Send Slack notification
      # Este job estÃ¡ deshabilitado por defecto
      # Para habilitarlo, cambia "false" por "true" arriba y configura SLACK_WEBHOOK_URL
      run: |
        echo "Slack notifications disabled"
        echo "To enable: set SLACK_WEBHOOK_URL secret and change condition above"