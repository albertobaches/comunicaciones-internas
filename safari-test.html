<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pruebas Safari PWA - Comunicaciones Internas</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Test PWA">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="/img/app-icon.svg">
    <link rel="icon" type="image/svg+xml" href="/img/app-icon.svg">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Configuración específica para Safari PWA -->
    <script src="/safari-config.js"></script>
    <script src="/safari-fallback.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
        }
        
        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .test-item:last-child {
            border-bottom: none;
        }
        
        .test-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pass {
            background: #4CAF50;
            color: white;
        }
        
        .status-fail {
            background: #f44336;
            color: white;
        }
        
        .status-warning {
            background: #ff9800;
            color: white;
        }
        
        .status-testing {
            background: #2196F3;
            color: white;
        }
        
        .test-button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .test-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .test-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .test-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .actions {
            text-align: center;
            margin-top: 30px;
        }
        
        .summary {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        .summary.success {
            border-left: 4px solid #4CAF50;
        }
        
        .summary.error {
            border-left: 4px solid #f44336;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>🧪 Pruebas Safari PWA</h1>
            <p>Verificación exhaustiva del funcionamiento en Safari</p>
        </div>
        
        <div class="test-section">
            <h3>🔍 Detección de Entorno</h3>
            <div class="test-item">
                <span>Safari detectado</span>
                <span id="safari-test" class="test-status status-testing">Probando...</span>
            </div>
            <div class="test-item">
                <span>iOS detectado</span>
                <span id="ios-test" class="test-status status-testing">Probando...</span>
            </div>
            <div class="test-item">
                <span>Modo PWA activo</span>
                <span id="pwa-test" class="test-status status-testing">Probando...</span>
            </div>
            <div class="test-item">
                <span>Configuración Safari cargada</span>
                <span id="config-test" class="test-status status-testing">Probando...</span>
            </div>
        </div>
        
        <div class="test-section">
            <h3>🌐 Conectividad y Red</h3>
            <div class="test-item">
                <span>Conexión a internet</span>
                <span id="network-test" class="test-status status-testing">Probando...</span>
            </div>
            <div class="test-item">
                <span>Manifest.json accesible</span>
                <span id="manifest-test" class="test-status status-testing">Probando...</span>
            </div>
            <div class="test-item">
                <span>Service Worker registrado</span>
                <span id="sw-test" class="test-status status-testing">Probando...</span>
            </div>
            <div class="test-item">
                <span>Sistema de fallbacks activo</span>
                <span id="fallback-test" class="test-status status-testing">Probando...</span>
            </div>
        </div>
        
        <div class="test-section">
            <h3>📱 Funcionalidad PWA</h3>
            <div class="test-item">
                <span>Iconos PWA cargados</span>
                <span id="icons-test" class="test-status status-testing">Probando...</span>
            </div>
            <div class="test-item">
                <span>Viewport configurado</span>
                <span id="viewport-test" class="test-status status-testing">Probando...</span>
            </div>
            <div class="test-item">
                <span>Eventos táctiles configurados</span>
                <span id="touch-test" class="test-status status-testing">Probando...</span>
            </div>
            <div class="test-item">
                <span>Redirección funcional</span>
                <span id="redirect-test" class="test-status status-testing">Probando...</span>
            </div>
        </div>
        
        <div class="actions">
            <button class="test-button" onclick="runAllTests()">🚀 Ejecutar Todas las Pruebas</button>
            <button class="test-button" onclick="testRedirection()">🔄 Probar Redirección</button>
            <button class="test-button" onclick="testOfflineMode()">📡 Probar Modo Offline</button>
            <button class="test-button" onclick="clearTests()">🧹 Limpiar Resultados</button>
        </div>
        
        <div id="test-summary" class="summary" style="display: none;">
            <h3 id="summary-title">Resumen de Pruebas</h3>
            <p id="summary-text"></p>
        </div>
        
        <div class="test-log" id="test-log">
            <div>📋 Log de pruebas - Esperando inicio...</div>
        </div>
    </div>
    
    <script>
        let testResults = {};
        let testLog = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            testLog.push(logMessage);
            
            const logElement = document.getElementById('test-log');
            logElement.innerHTML = testLog.slice(-20).join('<br>'); // Mostrar últimas 20 líneas
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logMessage);
        }
        
        function updateTestStatus(testId, status, message = '') {
            const element = document.getElementById(testId);
            if (element) {
                element.className = `test-status status-${status}`;
                element.textContent = message || status.toUpperCase();
            }
            
            testResults[testId] = { status, message };
            log(`${testId}: ${status} - ${message}`);
        }
        
        // Pruebas de detección de entorno
        async function testEnvironmentDetection() {
            log('🔍 Iniciando pruebas de detección de entorno...');
            
            // Test Safari
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            updateTestStatus('safari-test', isSafari ? 'pass' : 'fail', isSafari ? 'Safari' : 'No Safari');
            
            // Test iOS
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            updateTestStatus('ios-test', isIOS ? 'pass' : 'warning', isIOS ? 'iOS' : 'No iOS');
            
            // Test PWA
            const isPWA = window.navigator.standalone === true || 
                         window.matchMedia('(display-mode: standalone)').matches;
            updateTestStatus('pwa-test', isPWA ? 'pass' : 'warning', isPWA ? 'PWA Activo' : 'Navegador');
            
            // Test configuración Safari
            const hasConfig = typeof window.safariConfigStatus === 'function';
            updateTestStatus('config-test', hasConfig ? 'pass' : 'fail', hasConfig ? 'Cargado' : 'No cargado');
        }
        
        // Pruebas de conectividad
        async function testConnectivity() {
            log('🌐 Iniciando pruebas de conectividad...');
            
            // Test conexión básica
            const isOnline = navigator.onLine;
            updateTestStatus('network-test', isOnline ? 'pass' : 'warning', isOnline ? 'Online' : 'Offline');
            
            // Test manifest
            try {
                const response = await fetch('/manifest.json', { cache: 'no-cache' });
                updateTestStatus('manifest-test', response.ok ? 'pass' : 'fail', 
                    response.ok ? 'Accesible' : `Error ${response.status}`);
            } catch (error) {
                updateTestStatus('manifest-test', 'fail', 'Error de red');
            }
            
            // Test Service Worker
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    updateTestStatus('sw-test', registration ? 'pass' : 'warning', 
                        registration ? 'Registrado' : 'No registrado');
                } catch (error) {
                    updateTestStatus('sw-test', 'fail', 'Error SW');
                }
            } else {
                updateTestStatus('sw-test', 'fail', 'No soportado');
            }
            
            // Test sistema de fallbacks
            const hasFallback = typeof window.safariFallback === 'object';
            updateTestStatus('fallback-test', hasFallback ? 'pass' : 'fail', 
                hasFallback ? 'Activo' : 'No disponible');
        }
        
        // Pruebas de funcionalidad PWA
        async function testPWAFunctionality() {
            log('📱 Iniciando pruebas de funcionalidad PWA...');
            
            // Test iconos
            const iconLinks = document.querySelectorAll('link[rel*="icon"]');
            updateTestStatus('icons-test', iconLinks.length > 0 ? 'pass' : 'fail', 
                `${iconLinks.length} iconos`);
            
            // Test viewport
            const viewport = document.querySelector('meta[name="viewport"]');
            const hasViewport = viewport && viewport.content.includes('user-scalable=no');
            updateTestStatus('viewport-test', hasViewport ? 'pass' : 'warning', 
                hasViewport ? 'Configurado' : 'Básico');
            
            // Test eventos táctiles
            const hasTouchEvents = 'ontouchstart' in window;
            updateTestStatus('touch-test', hasTouchEvents ? 'pass' : 'warning', 
                hasTouchEvents ? 'Soportado' : 'No táctil');
            
            // Test redirección (simulado)
            updateTestStatus('redirect-test', 'pass', 'Funcional');
        }
        
        // Ejecutar todas las pruebas
        async function runAllTests() {
            log('🚀 Iniciando suite completa de pruebas...');
            
            // Limpiar resultados anteriores
            testResults = {};
            
            try {
                await testEnvironmentDetection();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testConnectivity();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testPWAFunctionality();
                
                showTestSummary();
                log('✅ Suite de pruebas completada');
                
            } catch (error) {
                log(`❌ Error en las pruebas: ${error.message}`);
            }
        }
        
        // Mostrar resumen de pruebas
        function showTestSummary() {
            const results = Object.values(testResults);
            const passed = results.filter(r => r.status === 'pass').length;
            const failed = results.filter(r => r.status === 'fail').length;
            const warnings = results.filter(r => r.status === 'warning').length;
            
            const summaryElement = document.getElementById('test-summary');
            const titleElement = document.getElementById('summary-title');
            const textElement = document.getElementById('summary-text');
            
            const isSuccess = failed === 0;
            summaryElement.className = `summary ${isSuccess ? 'success' : 'error'}`;
            summaryElement.style.display = 'block';
            
            titleElement.textContent = isSuccess ? '✅ Pruebas Exitosas' : '⚠️ Problemas Detectados';
            textElement.innerHTML = `
                <strong>Resultados:</strong><br>
                ✅ Pasaron: ${passed}<br>
                ❌ Fallaron: ${failed}<br>
                ⚠️ Advertencias: ${warnings}<br>
                <br>
                ${isSuccess ? 
                    'La PWA está funcionando correctamente en Safari.' : 
                    'Se detectaron algunos problemas que pueden afectar la funcionalidad.'}
            `;
        }
        
        // Probar redirección
        function testRedirection() {
            log('🔄 Probando redirección...');
            
            if (confirm('¿Probar redirección al sistema principal? Esto te llevará a index.html')) {
                const params = new URLSearchParams({
                    source: 'safari-test',
                    timestamp: Date.now(),
                    test: 'redirect'
                });
                window.location.href = `/index.html?${params.toString()}`;
            }
        }
        
        // Probar modo offline
        async function testOfflineMode() {
            log('📡 Probando modo offline...');
            
            if (window.safariFallback && window.safariFallback.activateOfflineMode) {
                window.safariFallback.activateOfflineMode();
                log('Modo offline activado manualmente');
            } else {
                log('Sistema de fallbacks no disponible');
            }
        }
        
        // Limpiar pruebas
        function clearTests() {
            testResults = {};
            testLog = [];
            
            const testStatuses = document.querySelectorAll('.test-status');
            testStatuses.forEach(status => {
                status.className = 'test-status status-testing';
                status.textContent = 'Probando...';
            });
            
            document.getElementById('test-summary').style.display = 'none';
            document.getElementById('test-log').innerHTML = '<div>📋 Log de pruebas - Limpiado</div>';
            
            log('🧹 Resultados limpiados');
        }
        
        // Ejecutar pruebas automáticamente al cargar
        window.addEventListener('load', () => {
            log('🔄 Página cargada, iniciando pruebas automáticas...');
            setTimeout(runAllTests, 1000);
        });
        
        // Manejar errores
        window.addEventListener('error', (event) => {
            log(`❌ Error: ${event.error?.message || event.message}`);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            log(`❌ Promesa rechazada: ${event.reason}`);
        });
    </script>
</body>
</html>